# 2025.01.22 TIL
### SQL 중급(계층 쿼리, 그룹함수), SQL 고급(View, Sequence)
어제 배운 계층 쿼리에 대해서 한 번 더 배우고, 심화 문제를 풀어보는 시간을 가졌습니다.
총 5문제가 제시 되었으며 계층 쿼리에 좀 더 익숙해지는 계기였습니다.
그리고 그룹함수의 개념과 사용법에 대해서 배웠고 실습 및 심화문제를 풀어봤습니다.
심화문제로 총 5문제가 제시됐고 계층 쿼리, 그룹함수를 적절히 혼합해서 해결할 수 있는 문제들이었습니다.

View, Sequence에 대해서 배웠습니다.
View에 대해서는 개념에 대해서는 인지했으나 어느 상황에 효율적일지에 대해서는 지식이 부족했습니다.
내부 개발 시 권한을 분리하여 특정 데이터에만 접근하게 할 때 사용한다는 점은 충분히 공감이 된 것 같습니다.
이후 Sequence의 경우 oracle에서 사용하는 방식에 대해 직접 쿼리를 쳐보면서 이해해 보는 시간이었습니다.

아래에 오늘 작성한 문제들의 쿼리 첨부합니다.
```MYSQL
-- 1.
select level, e1.employee_id, e1.name, e1.job_id, e1.manager_id, nvl(e2.name, '대표') from employees e1
left join employees e2
on e1.manager_id = e2.employee_id
start with e1.manager_id is null
connect by prior e1.employee_id = e1.manager_id
order siblings by e1.name;

-- 2.
select * from
(
select t.employee_id, t.name, t.salary, t.hi, rank() over(partition by hi order by salary desc) as employee_rank from 
(
select employee_id, name, salary, level as hi
from employees
start with manager_id is null
connect by prior employee_id = manager_id
) t
) t2
where employee_rank <= 3;

-- 3.
select employee_id, name, salary, level as hi, salary_avg
from employees e,
(
select level as hi, round(avg(salary),0) as salary_avg
from employees
start with manager_id is null
connect by prior employee_id = manager_id
group by level
) t
where level = t.hi
start with manager_id is null
connect by prior employee_id = manager_id;

-- 4.
select employee_id, name, salary, manager_name, manager_salary from
(
select level, e1.employee_id, e1.name, e1.job_id, e1. salary, e1.manager_id, e2.name as manager_name, e2.salary as manager_salary from employees e1
left join employees e2
on e1.manager_id = e2.employee_id
start with e1.manager_id is null
connect by prior e1.employee_id = e1.manager_id
order siblings by e1.name
)
where manager_salary < salary;


-- 5.
select name, nvl(department_name, 'No DEPT'), sys_connect_by_path(department_name, '->') as path
from employees e
left join departments d
on e.department_id = d.department_id
start with e.manager_id is null
connect by prior e.employee_id = e.manager_id;

-- 6.
select job_id, branch_id, sum(amount) from loans l
left join employees e
on l.customer_id = e.employee_id
group by cube(job_id, branch_id)
order by job_id, branch_id;

-- 7.
select department_id, job_id, sum(salary) from employees
where department_id is not null
group by grouping sets(department_id, job_id, ())
order by department_id, job_id;

-- 8.
select 
nvl(to_char(branch_id), 'Total'), 
nvl(status, '=============='),
sum(amount) from loans
group by rollup(branch_id, status)
order by branch_id, status;

-- 9.
select level, count(*)
from employees
start with manager_id is null
connect by prior employee_id = manager_id
group by level;

-- 10.
select nvl((select name from customers where customer_id = t.customer_id), 'Total'), nvl(t.status, 'All Status'), t.total_amount from
(
select nvl((select name from customers where customer_id = l.customer_id), 'Total'), nvl(l.status, 'All Status'), sum(amount) as total_amount from loans l
group by rollup(customer_id, status)
order by customer_id, status
) t;


select nvl((select name from customers where customer_id = l.customer_id), 'Total') as 고객이름, nvl(l.status, 'All Status') as 대출상태, sum(amount) as 대출금액 from loans l
group by rollup(customer_id, status)
order by customer_id, status;


```
